# 4D Parallelism

Last updated: 2024-10-22 (Oct 22, 2024)

Some experiments are being re-conducted with `TORCH_NCCL_AVOID_RECORD_STREAMS=1` set.

## A100 (40GB)

Environment: A100 (40GB) x 8 GPUs (https://docs.abci.ai/en/system-overview/ A node)

Llama-3.1-8B context length 8192

| (TP, CP, PP, micro batch) | 8 GPU  | 16 GPU | 32 GPU | 64 GPU | 128 GPU | 256 GPU |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 1, 2, 1)              | 182.6  | 178.38 | 176.79 | 170.84 | 169.52  | 153.9   |
| (4, 1, 2, 2)              | -      | 189.79 | 187.01 | 185.69 | 182.28  | 178.62  |
| (4, 1, 2, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 2, 2, 1)              |        | 151.65 | 148.7  | 142.34 | 134.34  | 116.28  |
| (4, 2, 2, 2)              |        | 155.01 | 160.27 | 158.15 | 150.64  | 127.03  |
| (4, 2, 2, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 2, 2, 1)              | -      | 192.62 | 185.07 | 178.58 | 165.2   | 142.61  |
| (2, 2, 2, 2)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 4, 2, 1)              |        | 155.35 | 139.46 | 124.56 | 108.73  | 98.79   |
| (2, 4, 2, 2)              |        | -      | 140.68 | 138.89 | 124.05  | 117.65  |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 2, 1, 1)              | -      | 174.07 | 171.99 | 168.66 | 162.15  | 153.03  |
| (4, 2, 1, 2)              | ãƒ¼     | 188.97 | 187.29 | 185.35 | 183.49  | 181.97  |
| (4, 2, 1, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 2, 4, 1)              |        | 153.99 | 137.78 | 133.72 | 121.44  |         |
| (2, 2, 4, 2)              |        | -      | 143.15 | 135.33 | 126.91  |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 4, 1, 1)              | -      | -      | 163.1  | 153.42 | 144.44  | 131.53  |
| (2, 4, 1, 2)              | -      | -      | -      | -      | -       | -       |
| (2, 4, 1, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|


## H100 (94GB)

Environment: H100 (94GB) x 4 GPUs (https://www.t4.gsic.titech.ac.jp/docs/handbook.en/)

Llama-3.1-8B context length 8192

| (TP, CP, PP, micro batch) | 4 GPU  | 8 GPU  | 16 GPU | 32 GPU | 64 GPU  | 128 GPU |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 1, 1, 1)              | 446.72 | 443.45 | 439.87 | 438.69 | 435.34  | 426.88  |
| (2, 1, 1, 2)              | -      | 479.16 | 475.2  | 471.82 | 469.01  | 460.32  |
| (2, 1, 1, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 2, 1, 1)              | 396.83 | 393.96 | 391.4  | 383.28 | 382.72  | 359.54  |
| (2, 2, 1, 2)              | 421.59 | 418.79 | 422.93 | 418.39 | 414.46  | 394.02  |
| (2, 2, 1, 4)              | -      | 452.21 | 456.01 | 447.8  | 446.01  |         |
| (2, 2, 1, 8)              | -      | -      | -      | -      | -       |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 1, 1, 1)              | 408.29 | 406.13 | 402.58 | 402.04 | 397.55  | 364.17  |
| (4, 1, 1, 2)              | 443.83 | 439.61 | 439.53 | 438.38 | 433.62  | 411.39  |
| (4, 1, 1, 4)              | -      | 448.51 | 446.4  | 446.24 | 443.92  | 438.55  |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 1, 2, 1)              | 415.39 | 413.75 | 408    | 410.59 | 405.03  | 394.58  |
| (2, 1, 2, 2)              | 449.1  | 445.74 | 434.68 | 435.92 | 426.5   | 413.62  |
| (2, 1, 2, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (1, 2, 1, 1)              | -      | 495.9  | 487.58 | 481.69 |         |         |
| (1, 2, 1, 2)              | -      | -      | -      | -      |         |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (1, 4, 1, 1)              | 449.58 | 441.25 | 436.39 | 425.73 |         |         |
| (1, 4, 1, 2)              | -      | 465.92 | 462.95 | 448.61 |         |         |

Llama-3.1-8B context length 16384

| (TP, CP, PP, micro batch) | 4 GPU  | 8 GPU  | 16 GPU | 32 GPU | 64 GPU  | 128 GPU |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 1, 1, 1)              | -      | 497.56 | 494.06 | 493.34 | 492.28  |         |
| (2, 1, 1, 2)              | -      | -      | -      | -      | -       |         |
| (2, 1, 1, 4)              | -      | -      | -      | -      | -       | -       |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 2, 1, 1)              | 425.29 | 432.15 | 420.1  | 388.7  | 365.75  |         |
| (2, 2, 1, 2)              | 453.76 | 463.88 | 459.94 | 452.71 | 436.77  |         |
| (2, 2, 1, 4)              | -      | -      | -      | -      | -       |         |
| (2, 2, 1, 8)              | -      | -      | -      | -      | -       |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 1, 1, 1)              | 442.54 | 448.18 | 438.37 | 406.59 | 384.14  |         |
| (4, 1, 1, 2)              | 451.1  | 468.49 | 462.28 | 453.71 | 457.36  |         |
| (4, 1, 1, 4)              | -      | -      | -      | -      | -       |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 1, 2, 1)              | 448.13 | 450.76 | 433.43 | 399.61 | 365.75  |         |
| (2, 1, 2, 2)              | -      | -      | -      | -      | 436.77  |         |
| (2, 1, 2, 4)              | -      | -      | -      | -      | -       |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (1, 2, 1, 1)              | -      | -      | -      | -      |         |         |
| (1, 2, 1, 2)              | -      | -      | -      | -      |         |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (1, 4, 1, 1)              | -      | 501.05 | 439.89 | 409.41 | 363.59  |         |
| (1, 4, 1, 2)              | -      | -      | -      | -      | -       |         |
| (1, 4, 1, 4)              | -      | -      | -      | -      | -       |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (2, 4, 1, 1)              |        | 288.42 | 290.7  | 267.03 |         |         |
| (2, 4, 1, 2)              |        | 272.96 | 293.26 | 279.53 |         |         |
|---------------------------|--------|--------|--------|--------|---------|---------|
| (4, 2, 1, 1)              |        | 303.46 | 295.71 | 295.71 |         |         |
| (4, 2, 1, 2)              |        | 297.73 | 299.95 | 299.95 |         |         |

